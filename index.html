<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—É—Å–∏–Ω—ã–π –ò–Ω—Ç–µ—Ä–Ω–µ—Ç - –•–∞–±</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .hidden { display: none; }
        .site-card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .biom { display: inline-block; padding: 5px 10px; border-radius: 15px; margin-right: 10px; font-size: 12px; }
        .biom-swamp { background: #c6efcd; }
        .biom-tech { background: #c6d9f1; }
        .biom-art { background: #f1c6e7; }
        .status-pending {
    background: #fff3cd;
    color: #856404;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 10px;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 10px;
}

.owner-badge {
    background: #d4edda;
    color: #155724;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 10px;
}

.site-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.site-meta {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.site-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn-delete {
    background: #dc3545;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
}

.btn-approve {
    background: #28a745;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
}

.btn-reject {
    background: #ffc107;
    color: #212529;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
}

textarea {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: inherit;
}
    </style>
</head>
<body>
    <h1>ü¶¢ –ì—É—Å–∏–Ω—ã–π –ò–Ω—Ç–µ—Ä–Ω–µ—Ç</h1>
    
    <div id="auth-section">
        <div id="logged-out">
            <h3>–í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="email" id="email" placeholder="email">
            <input type="password" id="password" placeholder="–ø–∞—Ä–æ–ª—å">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <button onclick="signup()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
        <div id="logged-in" class="hidden">
            <h3>–ü—Ä–∏–≤–µ—Ç, <span id="user-email"></span>!</h3>
            <button onclick="logout()">–í—ã–π—Ç–∏</button>
            
            <h4>–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π —Å–∞–π—Ç:</h4>
            <input type="text" id="site-url" placeholder="URL –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ (–º–æ–∂–Ω–æ –±–µ–∑ http://)">
            <input type="text" id="site-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞">
            <textarea id="site-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–∞–π—Ç–∞" rows="3"></textarea>
            <select id="site-biom">
                <option value="swamp">ü¶¢ –ë–æ–ª–æ—Ç–æ (–±–ª–æ–≥–∏, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è)</option>
                <option value="tech">üåÄ –¢–µ—Ö–Ω–æ–±–æ–ª–æ—Ç–æ (–∫–æ–¥, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)</option>
                <option value="art">üé® –õ—É–≥–∞ –∏—Å–∫—É—Å—Å—Ç–≤–∞ (–∞—Ä—Ç, –º—É–∑—ã–∫–∞)</option>
            </select>
            <button onclick="addSite()">–î–æ–±–∞–≤–∏—Ç—å –≤ –ì—É—Å–Ω–µ—Ç</button>
        </div>
    </div>
    
    <h2>–ö–∞—Ä—Ç–∞ —É–≥–æ–¥–∏–π</h2>
    <div id="sites-list"></div>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase (–í–°–¢–ê–í–¨–¢–ï –°–í–û–ò –ö–õ–Æ–ß–ò!)
        const supabaseUrl = 'https://uvhtwedzxejuwiaofavk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2aHR3ZWR6eGVqdXdpYW9mYXZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNDA3MjgsImV4cCI6MjA4MDcxNjcyOH0.9l4Xlj4CwRJS9Q3cT-pK9udW25-ptewrozUDbLgTjUM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                document.getElementById('logged-out').classList.add('hidden');
                document.getElementById('logged-in').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                loadSites();
            }
        }
        
        async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    // –†–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
    const redirectTo = window.location.origin + '/auth.html';
    
    const { error } = await supabase.auth.signInWithPassword({ 
        email, 
        password 
    }, {
        redirectTo: redirectTo  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
    });
    
    if (error) alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
}

async function signup() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    // –†–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ—á—Ç—ã
    const redirectTo = window.location.origin + '/auth.html';
    
    const { error } = await supabase.auth.signUp({ 
        email, 
        password 
    }, {
        redirectTo: redirectTo  // –ö–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä!
    });
    
    if (error) {
        alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
    } else {
        alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
    }
}
        
        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–∞–π—Ç–æ–≤
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–∞–π—Ç–æ–≤
async function loadSites() {
    const { data: { user } } = await supabase.auth.getUser();
    const { data: sites, error } = await supabase
        .from('sites')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) {
        console.error(error);
        document.getElementById('sites-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        return;
    }
    
    const container = document.getElementById('sites-list');
    
    if (sites.length === 0) {
        container.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–∞–π—Ç–æ–≤. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</p>';
        return;
    }
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç–∞—Ç—É—Å—É
    const pendingSites = sites.filter(s => s.status === 'pending');
    const approvedSites = sites.filter(s => s.status === 'approved');
    const rejectedSites = sites.filter(s => s.status === 'rejected');
    
    let html = '';
    
    // –¢–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –≤–∏–¥—è—Ç –æ–∂–∏–¥–∞—é—â–∏–µ —Å–∞–π—Ç—ã
    if (user && (await isModerator(user.id)) && pendingSites.length > 0) {
        html += `<h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (${pendingSites.length})</h3>`;
        html += pendingSites.map(site => renderSiteCard(site, user, true)).join('');
    }
    
    // –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ —Å–∞–π—Ç—ã –≤–∏–¥—è—Ç –≤—Å–µ
    html += `<h3>‚úÖ –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ —Å–∞–π—Ç—ã (${approvedSites.length})</h3>`;
    html += approvedSites.map(site => renderSiteCard(site, user, false)).join('');
    
    // –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã
    if (user && rejectedSites.filter(s => s.user_id === user.id).length > 0) {
        html += `<h3>‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –≤–∞—à–∏)</h3>`;
        html += rejectedSites
            .filter(s => s.user_id === user.id)
            .map(site => renderSiteCard(site, user, false))
            .join('');
    }
    
    container.innerHTML = html || '<p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–∞–π—Ç–æ–≤</p>';
}

// –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å–∞–π—Ç–∞
function renderSiteCard(site, currentUser, isPending = false) {
    const isOwner = currentUser && site.user_id === currentUser.id;
    const isMod = currentUser && window.isCurrentUserModerator;
    
    let statusBadge = '';
    if (site.status === 'pending') statusBadge = '<span class="status-pending">‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</span>';
    if (site.status === 'rejected') statusBadge = '<span class="status-rejected">‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω</span>';
    
    return `
        <div class="site-card" data-site-id="${site.id}">
            <div class="site-header">
                <span class="biom biom-${site.category}">${getBiomName(site.category)}</span>
                ${statusBadge}
                ${isOwner ? '<span class="owner-badge">‚ú® –í–∞—à —Å–∞–π—Ç</span>' : ''}
            </div>
            <h3><a href="${site.url}" target="_blank">${site.title}</a></h3>
            <p>${site.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
            <p class="site-meta">–î–æ–±–∞–≤–ª–µ–Ω: ${new Date(site.created_at).toLocaleDateString()}</p>
            
            <div class="site-actions">
                ${isOwner || isMod ? `
                    <button onclick="deleteSite('${site.id}')" class="btn-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                ` : ''}
                
                ${isPending && isMod ? `
                    <button onclick="moderateSite('${site.id}', 'approved')" class="btn-approve">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                    <button onclick="moderateSite('${site.id}', 'rejected')" class="btn-reject">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                ` : ''}
                
                ${site.status === 'rejected' && isMod ? `
                    <button onclick="moderateSite('${site.id}', 'approved')" class="btn-approve">‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                ` : ''}
            </div>
        </div>
    `;
}
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞
        async function addSite() {
    const url = document.getElementById('site-url').value;
    const title = document.getElementById('site-title').value;
    const biom = document.getElementById('site-biom').value;
    const description = document.getElementById('site-description')?.value || '–ù–æ–≤—ã–π —Å–∞–π—Ç –≤ –ì—É—Å–Ω–µ—Ç–µ';
    
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (!user) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!');
        return;
    }
    
    if (!url || !title) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ URL –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º http:// –µ—Å–ª–∏ –Ω–µ—Ç
    let finalUrl = url;
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        finalUrl = 'https://' + url;
    }
    
    const { data, error } = await supabase
        .from('sites')
        .insert([{ 
            url: finalUrl, 
            title, 
            category: biom,
            description: description,
            user_id: user.id,
            status: 'pending' // –¢–µ–ø–µ—Ä—å –≤—Å–µ —Å–∞–π—Ç—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏!
        }])
        .select();
    
    if (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    } else {
        alert('–°–∞–π—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!');
        document.getElementById('site-url').value = '';
        document.getElementById('site-title').value = '';
        if (document.getElementById('site-description')) {
            document.getElementById('site-description').value = '';
        }
        loadSites();
    }
}
        
        function getBiomName(code) {
            const map = { swamp: 'ü¶¢ –ë–æ–ª–æ—Ç–æ', tech: 'üåÄ –¢–µ—Ö–Ω–æ', art: 'üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ' };
            return map[code] || code;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º
async function isModerator(userId) {
    if (!userId) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã
    if (window.moderatorCache && window.moderatorCache[userId] !== undefined) {
        return window.moderatorCache[userId];
    }
    
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ moderators
        const { data, error, count } = await supabase
            .from('moderators')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', userId);
        
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:', error);
            return false;
        }
        
        const isMod = count > 0;
        
        // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞ 5 –º–∏–Ω—É—Ç)
        if (!window.moderatorCache) window.moderatorCache = {};
        window.moderatorCache[userId] = isMod;
        
        // –û—á–∏—â–∞–µ–º –∫—ç—à —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
        setTimeout(() => {
            if (window.moderatorCache) {
                delete window.moderatorCache[userId];
            }
        }, 5 * 60 * 1000);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.isCurrentUserModerator = isMod;
        
        return isMod;
    } catch (error) {
        console.error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ isModerator:', error);
        return false;
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞
async function deleteSite(siteId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–∞–π—Ç –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    
    const { error } = await supabase
        .from('sites')
        .delete()
        .eq('id', siteId);
    
    if (error) {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
    } else {
        alert('–°–∞–π—Ç —É–¥–∞–ª—ë–Ω');
        loadSites();
    }
}

// –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Å–∞–π—Ç–∞
async function moderateSite(siteId, action) {
    const status = action === 'approved' ? 'approved' : 'rejected';
    const message = action === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω' : '–æ—Ç–∫–ª–æ–Ω—ë–Ω';
    
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${message} —ç—Ç–æ—Ç —Å–∞–π—Ç?`)) return;
    
    const { error } = await supabase
        .from('sites')
        .update({ status: status })
        .eq('id', siteId);
    
    if (error) {
        alert('–û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏: ' + error.message);
    } else {
        alert(`–°–∞–π—Ç ${message}`);
        loadSites();
    }
}
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkAuth();
    </script>
</body>
</html>
